#! /bin/bash

. @DRBD_TEST_LIB@
set -e

CONF=/etc/rsyslog.d/forward.conf
SERVER=$1
PORT=$2
HOSTNAME=$3

status=
msg=$(ping -c1 -w2 "$SERVER" 2>&1) || status=$?
if [ -n "$status" ]; then
   echo "Cannot reach $host:" >&2
   echo "$msg" >&2
   exit $status
fi

rm -f "$CONF"
sed -e "s:@PORT@:$PORT:g" \
    -e "s:@SERVER@:$SERVER:g" \
    -e "s:@HOSTNAME@:$HOSTNAME:g" \
    @DRBD_TEST_DATA@/rsyslog-forward.conf.in \
    > "$CONF"
register_cleanup --job="$DRBD_TEST_JOB" -- reset-rsyslogd "$CONF"

service rsyslog restart
